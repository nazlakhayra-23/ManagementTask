<?php
require_once __DIR__ . '/../includes/db.php';

$message = '';

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = $_POST['username'] ?? '';

    if ($username) {
        // Check if user exists
        $result = mysqli_query($koneksi, "SELECT id FROM users WHERE username = '$username'");
        $user = mysqli_fetch_assoc($result);

        if ($user) {
            // Generate simple reset token
            $token = md5(uniqid());
            $expires = date('Y-m-d H:i:s', time() + 3600); // 1 hour

            // Save token
            mysqli_query($koneksi, "UPDATE users 
                                  SET reset_token = '$token', 
                                      reset_expires = '$expires' 
                                  WHERE id = {$user['id']}");

            // Show reset link
            $resetLink = "/personal_task_system/pages/reset_password.php?token=$token";
            $message = "Your password reset link:<br><a href='$resetLink'>Click here to reset password</a>";
        } else {
            $message = "Username not found";
        }
    } else {
        $message = "Please enter your username";
    }
}

$pageTitle = "Reset Password";
require_once __DIR__ . '/../includes/header.php';
?>

<div class="card">
    <div class="card-body">
        <h4>Reset Password</h4>

        <?php if ($message): ?>
            <div class="alert alert-info"><?= $message ?></div>
        <?php endif; ?>

        <form method="POST">
            <div class="mb-3">
                <label>Username</label>
                <input type="text" name="username" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Reset Password</button>
            <a href="login.php" class="btn btn-link">Back to Login</a>
        </form>
    </div>
</div>

<?php require_once __DIR__ . '/../includes/footer.php'; ?>
