<?php
// edit_task.php
include "db.php";
if (!isset($_SESSION['user_id'])) { header("Location: login.php"); exit; }
include "header.php";

$user_id = $_SESSION['user_id'];
$id = isset($_GET['id']) ? intval($_GET['id']) : 0;
if ($id <= 0) {
    echo "<div class='alert alert-danger'>ID tidak ditemukan.</div>";
    include "footer.php";
    exit;
}

// Ambil task khusus milik user (cek kepemilikan)
$tstmt = mysqli_prepare($koneksi, "SELECT * FROM tasks WHERE id = ? AND user_id = ?");
mysqli_stmt_bind_param($tstmt, "ii", $id, $user_id);
mysqli_stmt_execute($tstmt);
$tres = mysqli_stmt_get_result($tstmt);
$task = mysqli_fetch_assoc($tres);
mysqli_stmt_close($tstmt);

if (!$task) {
    echo "<div class='alert alert-warning'>Tugas tidak ditemukan atau bukan milik Anda.</div>";
    include "footer.php";
    exit;
}

// Ambil kategori & prioritas milik user untuk dropdown
$cats_stmt = mysqli_prepare($koneksi, "SELECT id, name FROM categories WHERE user_id = ? ORDER BY name");
mysqli_stmt_bind_param($cats_stmt, "i", $user_id);
mysqli_stmt_execute($cats_stmt);
$cats_res = mysqli_stmt_get_result($cats_stmt);

$prs_stmt = mysqli_prepare($koneksi, "SELECT id, level FROM priorities WHERE user_id = ? ORDER BY weight DESC");
mysqli_stmt_bind_param($prs_stmt, "i", $user_id);
mysqli_stmt_execute($prs_stmt);
$prs_res = mysqli_stmt_get_result($prs_stmt);

// Jika ada POST => lakukan update
if ($_SERVER["REQUEST_METHOD"] === "POST") {
    $title = trim($_POST['title'] ?? '');
    $description = trim($_POST['description'] ?? '');
    $status = $_POST['status'] ?? 'pending';
    // jika user tidak memilih, gunakan 0 -> nanti SQL NULLIF(?,0) -> akan jadi NULL
    $category_id = !empty($_POST['category_id']) ? intval($_POST['category_id']) : 0;
    $priority_id = !empty($_POST['priority_id']) ? intval($_POST['priority_id']) : 0;

    if ($title === '') {
        $err = "Judul wajib diisi.";
    } else {
        // Update dengan pengecekan kepemilikan AND user_id = ?
        $update_sql = "UPDATE tasks SET title = ?, description = ?, status = ?, category_id = NULLIF(?,0), priority_id = NULLIF(?,0) WHERE id = ? AND user_id = ?";
        $up = mysqli_prepare($koneksi, $update_sql);
        mysqli_stmt_bind_param($up, "sssiii", $title, $description, $status, $category_id, $priority_id, $id, $user_id);
        $ok = mysqli_stmt_execute($up);
        mysqli_stmt_close($up);

        if ($ok) {
            header("Location: tasks.php?msg=" . urlencode("Task berhasil diperbarui"));
            exit;
        } else {
            $err = "Gagal update: " . mysqli_error($koneksi);
        }
    }
}
?>

<div class="card shadow-sm">
  <div class="card-body">
    <h4 class="card-title mb-4">✏️ Edit Tugas</h4>

    <?php if(!empty($err)): ?>
      <div class="alert alert-danger"><?= htmlspecialchars($err) ?></div>
    <?php endif; ?>

    <form method="POST">
      <div class="mb-3">
        <label class="form-label">Judul</label>
        <input type="text" name="title" class="form-control" required value="<?= htmlspecialchars($task['title']) ?>">
      </div>

      <div class="mb-3">
        <label class="form-label">Deskripsi</label>
        <textarea name="description" rows="4" class="form-control"><?= htmlspecialchars($task['description']) ?></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Kategori</label>
        <select name="category_id" class="form-select">
          <option value="">-- Pilih kategori (opsional) --</option>
          <?php while($c = mysqli_fetch_assoc($cats_res)): ?>
            <option value="<?= $c['id'] ?>" <?= ($task['category_id'] == $c['id']) ? 'selected' : '' ?>>
              <?= htmlspecialchars($c['name']) ?>
            </option>
          <?php endwhile; ?>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Prioritas</label>
        <select name="priority_id" class="form-select">
          <option value="">-- Pilih prioritas (opsional) --</option>
          <?php while($p = mysqli_fetch_assoc($prs_res)): ?>
            <option value="<?= $p['id'] ?>" <?= ($task['priority_id'] == $p['id']) ? 'selected' : '' ?>>
              <?= htmlspecialchars($p['level']) ?>
            </option>
          <?php endwhile; ?>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="pending" <?= $task['status']=='pending' ? 'selected' : '' ?>>Pending</option>
          <option value="done" <?= $task['status']=='done' ? 'selected' : '' ?>>Done</option>
        </select>
      </div>

      <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
      <a href="tasks.php" class="btn btn-link">Batal</a>
    </form>
  </div>
</div>

<?php include "footer.php"; ?>
