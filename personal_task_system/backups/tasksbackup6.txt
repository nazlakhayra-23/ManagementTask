<?php
// tasks.php - with quick filters + sorting (no pagination yet)
include "db.php";
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit;
}
$pageTitle = "My Tasks | Task Manager";
include "header.php";

$user_id = $_SESSION['user_id'];

// --- Ambil options untuk dropdown (category & priority) ---
$cats_q = mysqli_prepare($koneksi, "SELECT id, name FROM categories WHERE user_id = ? ORDER BY name");
mysqli_stmt_bind_param($cats_q, "i", $user_id);
mysqli_stmt_execute($cats_q);
$cats_res = mysqli_stmt_get_result($cats_q);

$prs_q = mysqli_prepare($koneksi, "SELECT id, level, weight FROM priorities WHERE user_id = ? ORDER BY weight DESC");
mysqli_stmt_bind_param($prs_q, "i", $user_id);
mysqli_stmt_execute($prs_q);
$prs_res = mysqli_stmt_get_result($prs_q);

// --- Ambil parameter dari GET ---
$search = trim($_GET['search'] ?? '');
$filter_cat = isset($_GET['category']) && $_GET['category'] !== '' ? intval($_GET['category']) : null;
$filter_pr = isset($_GET['priority']) && $_GET['priority'] !== '' ? intval($_GET['priority']) : null;
$quick = isset($_GET['quick']) ? $_GET['quick'] : ''; // 'pending' or 'done' or ''
$sort = isset($_GET['sort']) ? $_GET['sort'] : 'created_desc'; // default

// --- Bangun WHERE clause dinamis ---
$where = " WHERE t.user_id = ?";
$params = [$user_id];
$types = "i";

if ($filter_cat !== null) {
    $where .= " AND t.category_id = ?";
    $types .= "i"; $params[] = $filter_cat;
}
if ($filter_pr !== null) {
    $where .= " AND t.priority_id = ?";
    $types .= "i"; $params[] = $filter_pr;
}
if ($quick === 'pending' || $quick === 'done') {
    $where .= " AND t.status = ?";
    $types .= "s"; $params[] = $quick;
}
if ($search !== '') {
    $where .= " AND (t.title LIKE CONCAT('%', ?, '%') OR t.description LIKE CONCAT('%', ?, '%'))";
    $types .= "ss"; $params[] = $search; $params[] = $search;
}

// --- Tentukan ORDER BY berdasarkan $sort ---
$order_by = " ORDER BY t.created_at DESC"; // default
if ($sort === 'created_asc') {
    $order_by = " ORDER BY t.created_at ASC";
} elseif ($sort === 'priority_desc') {
    // use COALESCE to treat NULL weights as 0
    $order_by = " ORDER BY COALESCE(p.weight,0) DESC, t.created_at DESC";
}

// --- Final SQL (JOIN categories & priorities) ---
$sql = "SELECT t.*, c.name AS category, p.level AS priority, p.weight AS priority_weight
        FROM tasks t
        LEFT JOIN categories c ON t.category_id = c.id
        LEFT JOIN priorities p ON t.priority_id = p.id"
        . $where . $order_by;

// prepare
$stmt = mysqli_prepare($koneksi, $sql);
if (!$stmt) {
    die("Prepare failed: " . mysqli_error($koneksi));
}

// bind params (manual binding for small count)
switch (count($params)) {
    case 1:
        mysqli_stmt_bind_param($stmt, $types, $params[0]);
        break;
    case 2:
        mysqli_stmt_bind_param($stmt, $types, $params[0], $params[1]);
        break;
    case 3:
        mysqli_stmt_bind_param($stmt, $types, $params[0], $params[1], $params[2]);
        break;
    case 4:
        mysqli_stmt_bind_param($stmt, $types, $params[0], $params[1], $params[2], $params[3]);
        break;
    case 5:
        mysqli_stmt_bind_param($stmt, $types, $params[0], $params[1], $params[2], $params[3], $params[4]);
        break;
    case 6:
        mysqli_stmt_bind_param($stmt, $types, $params[0], $params[1], $params[2], $params[3], $params[4], $params[5]);
        break;
    default:
        // if more params appear, add cases or use dynamic binding approach
        break;
}

mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
?>

<?php // Flash message ?>
<?php if (isset($_SESSION['flash_msg'])): ?>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <?= htmlspecialchars($_SESSION['flash_msg']) ?>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <?php unset($_SESSION['flash_msg']); ?>
<?php endif; ?>


<!-- START: Tasks header (replace existing top block) -->
<div class="tasks-header mb-3">
  <div class="tasks-title">
    <h1 class="mb-0"><i class="bi bi-journal-check"></i> To-Do List</h1>
  </div>

  <div class="tasks-controls d-flex align-items-center" style="gap:10px;">
    <!-- filter form (compact) -->
    <form method="GET" class="filter-form d-flex align-items-center" style="gap:8px;">
      <?php if ($quick !== ''): ?>
        <input type="hidden" name="quick" value="<?= htmlspecialchars($quick) ?>">
      <?php endif; ?>

      <input type="text" name="search" class="form-control form-control-sm" placeholder="Search tasks..." value="<?= htmlspecialchars($search) ?>" style="min-width:200px;">
      <select name="category" class="form-select form-select-sm">
        <option value="">All Categories</option>
        <?php mysqli_data_seek($cats_res, 0); while ($c = mysqli_fetch_assoc($cats_res)): ?>
          <option value="<?= $c['id'] ?>" <?= ($filter_cat === intval($c['id'])) ? 'selected' : '' ?>><?= htmlspecialchars($c['name']) ?></option>
        <?php endwhile; ?>
      </select>

      <select name="priority" class="form-select form-select-sm">
        <option value="">All Priorities</option>
        <?php mysqli_data_seek($prs_res, 0); while ($p = mysqli_fetch_assoc($prs_res)): ?>
          <option value="<?= $p['id'] ?>" <?= ($filter_pr === intval($p['id'])) ? 'selected' : '' ?>><?= htmlspecialchars($p['level']) ?></option>
        <?php endwhile; ?>
      </select>

      <select name="sort" class="form-select form-select-sm">
        <option value="created_desc" <?= $sort==='created_desc' ? 'selected' : '' ?>>Newest</option>
        <option value="created_asc" <?= $sort==='created_asc' ? 'selected' : '' ?>>Oldest</option>
        <option value="priority_desc" <?= $sort==='priority_desc' ? 'selected' : '' ?>>Priority Highâ†’Low</option>
      </select>

      <button type="submit" class="btn btn-sm btn-outline-primary"><i class="bi bi-search"></i></button>
      <a href="tasks.php" class="btn btn-sm btn-outline-secondary">Reset</a>
    </form>

    <!-- Add button always visible at end -->
    <div class="add-btn ms-2">
      <a href="add_task.php" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i> Add</a>
    </div>
  </div>
</div>
<!-- END: Tasks header -->


<!-- Tasks table -->
<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Description</th>
            <th>Categories</th>
            <th>Priorities</th>
            <th>Created</th>
            <th>Status</th>
            <th class="text-end">Action</th>
          </tr>
        </thead>
        <tbody>
          <?php if (mysqli_num_rows($result) == 0): ?>
            <tr><td colspan="8" class="text-center py-4 text-muted">No Tasks.</td></tr>
          <?php endif; ?>

          <?php while ($row = mysqli_fetch_assoc($result)): ?>
            <tr>
              <td><?= $row['id'] ?></td>
              <td><?= htmlspecialchars($row['title']) ?></td>
              <td style="max-width:320px;">
                <?= htmlspecialchars(mb_strimwidth($row['description'], 0, 80, '...')) ?>
                <?php if (mb_strlen($row['description']) > 80): ?>
                <button class="btn btn-sm btn-link p-0 ms-2 open-desc" 
                data-bs-toggle="modal" data-bs-target="#descModal"
                data-title="<?= htmlspecialchars($row['title']) ?>"
                data-desc="<?= htmlspecialchars($row['description']) ?>">
                Details
                </button>
                <?php endif; ?>
              </td>

              <td><?= htmlspecialchars($row['category'] ?? '-') ?></td>
              <td><?= htmlspecialchars($row['priority'] ?? '-') ?></td>
              <td><?= $row['created_at'] ?></td>
              <td>
                <?php if($row['status'] == 'done'): ?>
                  <span class="badge bg-success">Done</span>
                <?php else: ?>
                  <span class="badge bg-secondary">Pending</span>
                <?php endif; ?>
              </td>
              <td class="text-end">
                <a href="edit_task.php?id=<?= $row['id'] ?>" class="btn btn-sm btn-outline-secondary" title="Edit"><i class="bi bi-pencil"></i></a>
                <a href="toggle_status.php?id=<?= $row['id'] ?>" class="btn btn-sm btn-outline-success" title="Mark Done / Undo"><i class="bi bi-check2-circle"></i></a>
                <a href="delete_task.php?id=<?= $row['id'] ?>" class="btn btn-sm btn-outline-danger" onclick="return confirm('Yakin mau menghapus tugas ini?')"><i class="bi bi-trash"></i></a>
              </td>
            </tr>
          <?php endwhile; ?>

        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Description Modal -->
<div class="modal fade" id="descModal" tabindex="-1" aria-labelledby="descModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="descModalLabel">Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6 id="descModalTitle" class="fw-bold mb-3"></h6>
        <div id="descModalBody" style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<?php include "footer.php"; ?>
