<?php
// tasks.php
include "db.php";
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit;
}
include "header.php";

$user_id = $_SESSION['user_id'];

// Ambil task milik user, JOIN category & priority
$sql = "SELECT t.*, c.name AS category, p.level AS priority
        FROM tasks t
        LEFT JOIN categories c ON t.category_id = c.id
        LEFT JOIN priorities p ON t.priority_id = p.id
        WHERE t.user_id = ?
        ORDER BY t.created_at DESC";

$stmt = mysqli_prepare($koneksi, $sql);
mysqli_stmt_bind_param($stmt, "i", $user_id);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
?>

<?php if (isset($_SESSION['flash_msg'])): ?>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <?= htmlspecialchars($_SESSION['flash_msg']) ?>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <?php unset($_SESSION['flash_msg']); ?>
<?php endif; ?>

<script>
  setTimeout(() => {
    const alertBox = document.querySelector('.alert');
    if (alertBox) {
      alertBox.classList.remove('show');
      alertBox.classList.add('fade');
      setTimeout(() => alertBox.remove(), 500);
    }
  }, 3000);
</script>


<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0"><i class="bi bi-journal-check"></i> Daftar Tugas</h1>
  <a href="add_task.php" class="btn btn-primary"><i class="bi bi-plus-lg"></i> Tambah</a>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Judul</th>
            <th>Deskripsi</th>
            <th>Kategori</th>
            <th>Prioritas</th>
            <th>Created</th>
            <th>Status</th>
            <th class="text-end">Aksi</th>
          </tr>
        </thead>
        <tbody>
          <?php if(mysqli_num_rows($result) == 0): ?>
            <tr>
              <td colspan="8" class="text-center py-4 text-muted">Belum ada tugas. <a href="add_task.php">Tambah tugas</a></td>
            </tr>
          <?php endif; ?>

          <?php while($row = mysqli_fetch_assoc($result)): ?>
            <tr>
              <td><?= $row['id'] ?></td>
              <td><?= htmlspecialchars($row['title']) ?></td>
              <td style="max-width:320px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><?= htmlspecialchars($row['description']) ?></td>
              <td><?= htmlspecialchars($row['category'] ?? '-') ?></td>
              <td><?= htmlspecialchars($row['priority'] ?? '-') ?></td>
              <td><?= $row['created_at'] ?></td>
              <td>
                <?php if($row['status'] == 'done'): ?>
                  <span class="badge bg-success">Done</span>
                <?php else: ?>
                  <span class="badge bg-secondary">Pending</span>
                <?php endif; ?>
              </td>
              <td class="text-end">
                <a href="edit_task.php?id=<?= $row['id'] ?>" class="btn btn-sm btn-outline-secondary" title="Edit"><i class="bi bi-pencil"></i></a>
                <a href="toggle_status.php?id=<?= $row['id'] ?>" class="btn btn-sm btn-outline-success" title="Mark Done / Undo"><i class="bi bi-check2-circle"></i></a>
                <a href="delete_task.php?id=<?= $row['id'] ?>" class="btn btn-sm btn-outline-danger" onclick="return confirm('Yakin mau menghapus tugas ini?')"><i class="bi bi-trash"></i></a>
              </td>
            </tr>
          <?php endwhile; ?>
        </tbody>
      </table>
    </div>
  </div>
</div>

<?php include "footer.php"; ?>
