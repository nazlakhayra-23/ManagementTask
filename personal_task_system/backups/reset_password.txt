<?php
// pages/reset_password.php - very simple and easy to understand
require_once __DIR__ . '/../includes/db.php';

// Get reset token
$token = $_GET['token'] ?? '';
$error = '';
$user = null;

// Check token exists
if (!$token) {
    header("Location: /personal_task_system/pages/forgot_password.php");
    exit;
}

// Find user by token
$result = mysqli_query($koneksi, "SELECT id, username FROM users WHERE reset_token = '$token'");
$user = mysqli_fetch_assoc($result);

// Handle password reset
if ($_SERVER['REQUEST_METHOD'] === 'POST' && $user) {
    $password = $_POST['password'] ?? '';
    $confirm = $_POST['password2'] ?? '';

    if ($password && $confirm && $password === $confirm) {
        // Update password
        $hash = password_hash($password, PASSWORD_DEFAULT);
        $user_id = $user['id'];
        mysqli_query($koneksi, "UPDATE users SET 
            password = '$hash',
            reset_token = NULL 
            WHERE id = $user_id");

        // Auto login
        $_SESSION['user_id'] = $user_id;
        $_SESSION['username'] = $user['username'];
        $_SESSION['flash_msg'] = "Password reset successful";
        header("Location: /personal_task_system/index.php");
        exit;
    } else {
        $error = "Passwords don't match";
    }
}

$pageTitle = "Reset Password";
require_once __DIR__ . '/../includes/header.php';
?>

<div class="card">
    <div class="card-body">
        <h4>Reset Password</h4>

        <?php if ($error): ?>
            <div class="alert alert-danger"><?= $error ?></div>
        <?php endif; ?>

        <?php if (!$user): ?>
            <div class="alert alert-warning">Invalid reset token</div>
            <a href="forgot_password.php" class="btn btn-primary">Request New Reset Link</a>
        <?php else: ?>
            <form method="POST">
                <div class="mb-3">
                    <label>New Password</label>
                    <input type="password" name="password" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Confirm Password</label>
                    <input type="password" name="password2" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary">Save Password</button>
                <a href="login.php" class="btn btn-link">Back to Login</a>
            </form>
        <?php endif; ?>
    </div>
</div>

<?php require_once __DIR__ . '/../includes/footer.php'; ?>
